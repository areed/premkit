machine:
  services:
    - docker
  environment:
    GOPATH: $HOME
    GO15VENDOREXPERIMENT: 1  # Because this is golang 1.5
    PREMKIT_DATA_FILE: /tmp/premkit.db
    PREMKIT_TAG: 1.0.0

checkout:
  post:
    - mkdir -p $HOME/src/github.com/premkit
    - cp -r $HOME/premkit $HOME/src/github.com/premkit/premkit

dependencies:
  override:
    - go get -u github.com/kardianos/govendor
    - cd $HOME/src/github.com/premkit/premkit && make build
  post:
    - cp $HOME/src/github.com/premkit/premkit/bin/premkit $CIRCLE_ARTIFACTS

test:
  pre:
    - GOPATH=/tmp go get github.com/axw/gocov/gocov
    - GOPATH=/tmp go get github.com/mattn/goveralls
    - go get github.com/stretchr/testify/assert
    - if ! GOPATH=/tmp go get github.com/golang/tools/cmd/cover; then GOPATH=/tmp go get golang.org/x/tools/cmd/cover; fi
  override:
    - cd $HOME/src/github.com/premkit/premkit/test && ./coverage.bash ./packages.txt ./profile.cov
  post:
    - /tmp/bin/goveralls -service=circle-ci -repotoken=$COVERALLS_REPO_TOKEN -coverprofile=$HOME/src/github.com/premkit/premkit/test/profile.cov

deployment:
  docker:
    branch: master
    owner: premkit
    commands:
      - cd $HOME/src/github.com/premkit/premkit && make build_docker
      - cd $HOME/src/github.com/premkit/premkit && PREMKIT_TAG=1.0.0 make package_docker
      - sudo docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - sudo docker tag -f premkit/premkit:$PREMKIT_TAG premkit/premkit:latest
      - sudo docker push premkit/premkit:$PREMKIT_TAG
      - sudo docker push premkit/premkit:latest
